# E2E 测试

February 1, 2024 

## 简介

**E2E 测试**，全称为**端到端测试（End-to-End Testing）**，**是一种软件测试方法**，用于验证软件应用程序是否能在各种用户场景下按照设计运行，确保系统的各个组件能够正确地协同工作，以完成特定的业务流程。这种测试方法从用户的角度出发，模拟真实用户操作环境，**检查软件从开始到结束的流程是否能够达到预期的结果。**

E2E 测试的目的不仅是验证软件的各个独立模块是否能够正常工作，而且还要确保这些模块在集成后能够以预定的方式相互作用。它覆盖了用户界面、数据库、网络通讯以及其他依赖服务，可以识别系统内部各个环节之间的交互问题。

进行 E2E 测试时，测试人员会设计测试用例，这些测试用例覆盖了用户可能的操作路径，包括正常流程和异常流程，以确保软件在各种条件下都能正常工作。这些测试通常在软件开发的后期进行，确保在软件发布前发现并修复重大问题。

E2E 测试可以手动进行，也可以通过自动化测试工具实现，自动化 E2E 测试可以节省时间，提高效率，特别是在软件更新频繁的情况下非常有用。常见的自动化 E2E 测试工具包括 **Selenium**、**Cypress**、**TestCafe** 等。

## 历史

E2E 测试的历史与软件开发实践的演进紧密相关，特别是随着软件系统变得日益复杂和分布式，对软件质量的要求也随之提高。虽然很难精确地追溯E2E测试的起源，但我们可以概述其发展的几个关键阶段。

### **早期的软件测试**

在计算机和软件技术的早期，软件测试主要集中在**单元测试**和**集成测试**上，目的是验证单个模块的功能和模块之间的接口。这个时期，软件通常较为简单，运行在单一的或高度控制的环境中，用户交互也相对有限。因此，测试的焦点更多在于确保软件的基本功能和性能。

### **系统集成和自动化测试的兴起**

随着计算机网络的发展和企业信息化的深入，软件系统开始越来越复杂，不仅仅是单个程序或应用，而是多个系统的集成。这要求测试不仅要覆盖单独的组件或模块，还要确保这些组件和模块能够在整个系统中协同工作。这一时期，端到端测试的概念开始形成，目的是模拟真实世界的使用场景，验证整个系统的行为。

同时，为了应对日益增长的测试需求，提高测试效率，自动化测试工具开始出现。这些工具允许测试者自动执行重复的测试任务，而不是手动进行，极大地提高了测试的效率和可靠性。

### **敏捷开发和持续集成**

进入21世纪，敏捷开发方法开始流行，它强调快速迭代和频繁发布。与此同时，**持续集成（CI）**和**持续部署（CD）**的实践也开始普及。在这种背景下，端到端测试的重要性进一步增加，因为它可以在软件发布前快速发现问题。自动化的E2E测试成为了敏捷团队和CI/CD流程中不可或缺的一部分。

### **现代E2E测试工具和实践**

随着Web应用和移动应用的爆炸式增长，E2E 测试面临了新的挑战和机遇。现代E2E测试工具，如**Selenium**、**Cypress**、**Puppeteer** 等，提供了更加强大和灵活的测试能力，支持跨浏览器和跨平台测试，能够模拟用户在真实环境中的行为。

同时，云计算和微服务架构的兴起也对E2E测试提出了新的要求。测试不仅需要覆盖用户界面，还要考虑网络通讯、服务间的依赖、数据一致性等因素。

## 工具

现代端到端（E2E）测试工具的发展和创新，为软件测试提供了更强大、更灵活的自动化测试解决方案。这些工具使得测试团队能够模拟真实用户的操作，从而确保应用程序在各种设备和浏览器上能够按预期工作。下面是一些广泛使用的现代E2E测试工具和它们的特点：

### **1. Selenium**

- **简介**：Selenium 是一款开源的自动化测试工具，非常适合用于Web应用的自动化测试。它支持多种编程语言，包括 Java、C#、Python、Ruby 等。
- **特点**：
    - 跨浏览器支持，可以在 Chrome、Firefox、Internet Explorer 等主流浏览器上运行测试。
    - 强大的社区支持和丰富的资源。
    - 与其他测试框架和工具（如 TestNG、JUnit、Cucumber）集成，支持复杂的测试需求。

### **2. Cypress**

- **简介**：Cypress 是一个更现代的 Web 测试工具，专为现代 Web 应用设计。与 Selenium 相比，它提供了更简洁的 API 和更快的测试执行速度。
- **特点**：
    - 直接在浏览器中执行测试，提供更一致的测试结果。
    - 内置的等待机制，自动等待命令和断言，无需显式等待。
    - 优秀的调试能力，通过截图和视频记录测试执行过程。
    - 友好的用户界面，便于查看测试的执行过程和结果。

### **3. Puppeteer**

- **简介**：Puppeteer 是 Google Chrome 团队开发的一个 Node 库，提供了一套高级 API 来控制Chrome 或 Chromium。Puppeteer 通常用于自动化浏览器任务，但也非常适合进行 E2E 测试。
- **特点**：
    - 支持生成页面截图和PDF，对于测试报告非常有用。
    - 能够模拟各种用户行为，如表单填写、键盘输入、文件上传等。
    - 支持网络请求拦截和模拟，便于测试应用中的异步请求。

### **4. Playwright**

- **简介**：Playwright 是由 Microsoft 开发的一个 Node 库，类似于 Puppeteer，但支持多个浏览器，包括 Chrome、Firefox、Safari 和 Webkit。
- **特点**：
    - 跨浏览器支持，能够在所有主流浏览器上以近乎相同的方式运行测试。
    - 支持移动端测试，模拟移动设备。
    - 强大的网络拦截能力，可以模拟网络条件和测试离线行为。
    - 支持多个浏览器上下文，便于同时测试多个用户场景。

### **5. TestCafe**

- **简介**：TestCafe 是一个用于Web应用测试的Node.js工具。它不依赖于WebDriver，因此安装和设置相对简单。
- **特点**：
    - 无需WebDriver，简化了测试环境的配置。
    - 支持跨浏览器测试，包括移动浏览器。
    - 具有内置的等待机制，自动处理元素加载等待问题。
    - 容易编写和运行测试，不需要深入的编程知识。

这些工具各有特点和优势，选择哪个工具取决于项目的具体需求、团队的技能以及应用程序的特性。现代E2E测试工具的发展，不仅提高了测试的效率和可靠性，也使得自动化测试变得更加易于实现和维护。

## E2E 与前端

E2E 测试在很大程度上与前端开发密切相关，因为它着重于模拟真实用户的操作和体验，以验证整个应用或系统的功能和性能。E2E测试的核心目的是确保应用程序在最终用户的设备上能够按预期工作，覆盖用户可能遇到的各种使用场景和流程。这种测试方法关注的是**用户界面（UI）**和**用户体验（UX）**的各个方面，包括但不限于：

- **用户交互**：验证用户与应用界面元素的交互是否按预期工作，如点击按钮、填写表单、导航菜单等。
- **业务流程**：模拟并验证完整的业务流程或事务，如购物流程、用户注册和登录、信息检索等。
- **数据处理**：检查应用是否能正确处理数据输入和输出，包括数据的存储、检索和显示。
- **跨浏览器和跨设备兼容性**：确保应用在不同的浏览器和设备上提供一致的用户体验。
- **性能问题**：识别在模拟的用户操作过程中可能出现的性能瓶颈，如页面加载时间、响应时间等。

虽然 E2E 测试与前端开发密切相关，但它的范围实际上是跨越整个应用的，从前端到后端，包括数据库、网络请求、API、服务器以及其他外部依赖和服务。E2E 测试的目的是确保所有这些部分协同工作，以提供符合预期的用户体验。

因此，尽管 E2E 测试很大程度上侧重于模拟用户在前端界面的操作，但它也考虑到了应用后端的逻辑和性能，确保从用户输入到系统处理再到输出反馈的整个流程无缝协作，满足功能和性能要求。这就是为什么 E2E 测试在软件开发和质量保证中扮演着重要角色的原因。

## E2E 页面最佳实践

E2E（端到端）测试对前端页面本身没有特定的要求，它旨在通过模拟最终用户的行为来验证整个应用或系统是否按照预期工作。理论上，所有前端页面都可以进行E2E测试，但是为了提高测试的效率和可靠性，以下是一些设计和开发前端页面时可以考虑的最佳实践：

### **1. 可访问性和可测试性**

- **明确的元素标识**：使用明确的ID、类名或数据属性（如**`data-test-id`**）来标识页面元素，这可以帮助测试脚本更容易地定位和操作这些元素。
- **避免使用动态生成的 ID**：对于自动化测试来说，固定的标识符比动态生成的 ID 更可靠。
- **语义化的 HTML**：使用合适的 HTML 元素来增强页面的语义化，这不仅有利于 SEO 和无障碍访问性，也可以使自动化测试更加准确。

### **2. 稳定的页面结构和动态内容处理**

- **稳定的结构**：确保页面的结构在不同的加载状态和用户交互后保持一定的稳定性，以避免测试脚本因页面突变而失败。
- **处理异步加载**：对于异步加载的内容（如AJAX请求返回的数据），确保测试脚本能够等待这些内容加载完成后再进行后续操作。许多现代的E2E测试框架提供了等待机制来处理这种情况。

### **3. 交互式元素的响应性和反馈**

- **清晰的反馈**：对用户的操作给出清晰的反馈，比如按钮点击后的状态变化、表单提交的进度指示，这可以帮助测试脚本判断操作是否成功。
- **合理的交互设计**：确保页面上的交互元素（如按钮、链接、表单等）设计合理，易于操作，这不仅提升用户体验，也便于测试脚本模拟用户行为。

### **4. 跨浏览器和设备的兼容性**

- **响应式设计**：确保页面能够在不同大小的视口和不同设备上正确显示和工作，这对于E2E测试在多环境下的兼容性检查尤为重要。

### **5. 错误处理和日志记录**

- **错误处理**：合理处理前端错误，并提供足够的错误信息，可以帮助测试人员快速定位问题。
- **日志记录**：在关键操作和流程中加入日志记录，对于测试分析和问题定位非常有帮助。

### **结论**

虽然几乎所有的前端页面都可以进行E2E测试，但是遵循上述最佳实践可以大大提高测试的可靠性和效率。一个良好设计的、易于测试的前端不仅有利于提高开发和测试的效率，也能够提升最终用户的体验。

## E2E 与 Canvas

对于使用Canvas绘制的表格进行端到端(E2E)测试，面临的主要挑战是Canvas元素本质上是一个位图，它不像HTML元素那样可以直接通过DOM操作或属性查询来进行交互和验证。这意味着，传统的基于DOM元素选择和操作的E2E测试方法对于Canvas元素不直接适用。不过，仍有一些方法可以用来测试使用Canvas的表格：

### **1. 基于视觉回归测试**

视觉回归测试是通过比较应用程序的屏幕截图在不同版本之间的差异来检测更改的一种方法。这种方法适用于Canvas绘制的表格，因为它关注的是最终的视觉输出而非DOM结构。

- **工具选择**：选择支持视觉回归测试的工具，如Percy、Applitools Eyes等，这些工具可以集成到你的E2E测试流程中。
- **测试实施**：在测试过程中，首先渲染你的Canvas表格，然后使用视觉回归测试工具捕捉当前视图的快照，并将其与基线快照进行比较。

### **2. 使用自定义JavaScript检查Canvas状态**

虽然Canvas的内容不是DOM元素，但你仍然可以通过JavaScript访问Canvas API，检查Canvas的状态或执行特定的操作。

- **状态验证**：如果你的应用程序以某种方式将表格数据状态同步到Canvas渲染逻辑，你可以通过执行自定义JavaScript代码来验证这些状态。例如，你可以检查与Canvas关联的JavaScript对象中的数据是否符合预期。
- **模拟交互**：通过编写脚本来模拟用户行为（如点击、拖动等），然后检查这些操作是否导致了预期的变化。这可能需要你的应用程序暴露一些接口或使用测试钩子来辅助测试。

### **3. 测试辅助层**

对于复杂的Canvas应用，考虑在开发阶段加入一个透明的测试辅助层。这个层可以是DOM元素，覆盖在Canvas元素之上，用于捕捉测试脚本发出的模拟事件，并将它们转换为Canvas可以理解的操作。

- **事件转发**：测试辅助层可以捕获模拟的用户交互事件（如点击、滑动等），并将这些事件转换为对Canvas API的调用。
- **状态映射**：在测试辅助层中维护一个状态映射，将视觉元素（如表格行、列）映射到Canvas中的相应图形对象。

### **结论**

对使用Canvas绘制的表格进行E2E测试需要一些创造性的方法，因为传统的基于DOM的测试策略无法直接应用。视觉回归测试、通过JavaScript检查Canvas状态、以及开发特定的测试辅助功能是可能的解决方案。这些方法各有优劣，可能需要根据具体的应用场景和测试需求进行选择和调整。

## Demo

创建一个复杂的端到端（E2E）测试示例需要选择一个具体的测试框架和应用场景。这里，我将提供一个使用Cypress对一个假想的电子商务网站进行E2E测试的基本示例。这个示例将涵盖用户登录、搜索产品、添加产品到购物车、并进行结算的完整流程。

### **前提条件**

- 安装Node.js和npm。
- 有一个假想的电子商务网站，页面和元素的选择器将根据假设进行命名。
- 已经安装了Cypress。

### **安装Cypress**

首先，在你的测试项目目录中安装Cypress：

```bash
npm install cypress --save-dev
```

### **创建测试用例**

1. 打开你的测试项目目录，初始化Cypress（如果尚未初始化）：

```
npx cypress open
```

这将打开Cypress的测试运行器，并在你的项目中创建一个**`cypress`**文件夹，里面包含了一些示例测试。

1. 在**`cypress/integration`**目录下创建一个新的测试文件，例如**`e2e_commerce_test.js`**。
2. 编写测试脚本：

```jsx
describe('E-commerce Site E2E Test', () => {
    it('Should login, search for a product, add it to the cart, and checkout', () => {
        // 访问电商网站
        cy.visit('https://example-ecommerce-site.com')

        // 登录
        cy.get('#login-link').click()
        cy.get('#username-input').type('testuser')
        cy.get('#password-input').type('testpassword')
        cy.get('#login-button').click()

        // 确认登录成功
        cy.contains('Welcome, testuser')

        // 搜索产品
        cy.get('#search-box').type('JavaScript Book{enter}')

        // 选择产品并添加到购物车
        cy.contains('JavaScript Book').click()
        cy.get('#add-to-cart').click()

        // 前往购物车
        cy.get('#cart').click()

        // 确认购物车中有产品
        cy.contains('JavaScript Book')

        // 进行结算
        cy.get('#checkout-button').click()

        // 填写地址信息
        cy.get('#address-input').type('123 Test Lane')
        cy.get('#city-input').type('Testville')
        cy.get('#state-select').select('Test State')
        cy.get('#zip-input').type('12345')

        // 提交订单
        cy.get('#submit-order').click()

        // 确认订单提交成功
        cy.contains('Thank you for your order')
    })
})
```

### **运行测试**

使用Cypress测试运行器或命令行运行你的测试：

```bash
npx cypress run
```

或者，如果你想在图形界面中选择并运行测试：

```bash
npx cypress open
```

### 结果

Cypress 通过执行定义在测试脚本中的一系列命令和断言来判断测试结果是否通过。每一步操作（如点击、输入文本、页面导航）和每一个断言（如 **`cy.contains`** 检查页面上是否存在某些文本）都会被Cypress执行和验证。测试结果是基于以下几个方面来判断的：

**1. 命令执行成功**

Cypress 会按照脚本中定义的顺序执行每个命令，如 **`cy.visit()`**, **`cy.click()`**, **`cy.type()`** 等。如果这些命令成功执行，即没有抛出错误（例如，元素未找到、操作超时等），则这些步骤被视为通过。

**2. 断言验证**

断言是测试中用来验证应用状态的表达式。例如，**`cy.contains('Welcome, testuser')`** 是一个断言，它检查页面上是否存在文本 **`Welcome, testuser`** 。如果指定的内容存在，断言通过；如果不存在，Cypress将报告一个错误，并且测试失败。断言是判断测试是否通过的关键。

**3. 无未捕获的异常**

如果在测试执行过程中发生JavaScript错误或未捕获的异常，Cypress通常会将测试标记为失败，除非明确配置为忽略这些错误。

**4. 满足特定条件**

某些测试可能包括等待特定条件成立，如等待网络请求完成或等待动画结束。如果这些条件在设定的超时时间内得到满足，则相关的步骤视为通过。

### **测试结果输出**

- **通过（Passed）**：如果所有的命令和断言都成功执行，且没有捕获到未处理的异常，则整个测试用例（ **`it`** 块）被标记为通过。
- **失败（Failed）**：如果任何命令执行失败、断言失败，或者捕获到未处理的异常，则测试用例被标记为失败。Cypress会在测试运行器界面详细列出失败的原因，包括失败的命令、断言以及可能的错误消息和堆栈跟踪。

### **调试和错误处理**

对于失败的测试，Cypress提供了丰富的调试支持，包括错误日志、截图和视频录制（如果配置）。这些工具可以帮助开发者和测试人员快速定位问题所在，理解为什么测试没有通过。

### **注意**

- 上述代码只是一个示例，实际使用时需要根据你的网站或应用的具体情况调整网址、选择器和逻辑。
- 确保在运行测试前，你的电子商务网站可以访问，并且所有的URL、ID和选择器都与你的网站对应。

这个示例展示了如何使用Cypress进行一系列的E2E测试操作，从用户登录到产品搜索，再到添加产品到购物车，最后进行结算。E2E测试可以根据你的应用需求进一步扩展，包括测试不同的用户路径、错误处理、响应时间等。

## 实战

### **`FSGTest.ts` （功能性测试助手类）**

这个文件看起来定义了一个测试助手类，其目的是**封装和组织用于执行特定测试任务的方法**，使得这些任务可以在测试脚本中以更简洁、可读和重用的方式被调用。该类中的方法包括：

- **点击添加分组条件**、**点击筛选按钮**、**等待视图加载完毕**等，这些方法通过 **`addTask`** 函数将不同的操作加入到一个任务队列中。这种方式允许异步操作按顺序执行，提高了代码的组织性和可维护性。
- 每个方法似乎都返回 **`this`**，支持链式调用，这样可以在单个表达式中串联多个操作，提高了代码的流畅性和易读性。
- 这些方法执行的操作包括与页面元素交互（如点击和输入）、等待某些条件（如视图加载完毕）、准备数据等，这些都是E2E测试中常见的需求。

### **`参与角色.ts`（具体的E2E测试用例）**

这个文件包含了具体的E2E测试用例，它使用了**`@pagepass/test`**库进行描述和执行测试。从文件内容来看，它专注于测试一个称为“筛选”的特定功能，通过以下步骤：

- 在 **`before`** 钩子中设置了页面cookie，这可能是为了模拟用户的登录状态或其他身份验证需求。
- 测试用例（ **`it`** 块）利用 **`测试助手类`** 实例执行一系列操作，如点击筛选按钮、添加筛选条件、选择字段和筛选项等，最后进行快照匹配来验证UI的状态。
- 这个测试用例展示了如何使用封装好的方法进行复杂的交互操作，并通过快照测试验证UI的变化是否符合预期。

### **他们之间的关系**

- **`FSGTest.ts`** 定义了一套测试工具或助手类，提供了多个方法来执行测试中的常见任务。
- **`参与角色.ts`** 则利用这个助手类来定义和执行具体的E2E测试用例。
- 这种分离的结构使得测试代码更加模块化和重用性强，同时保持了测试逻辑的清晰和可维护性。

总的来说，**`FSGTest.ts`** 作为一个工具或助手类，为编写和执行E2E测试提供了一系列方便的方法和操作，而**`参与角色.ts`**文件则利用这些工具来实现具体的测试逻辑和验证，两者共同构成了一套完整的E2E测试方案。

### 没有FSGTest.ts能实现e2e测试吗

即使没有**`FSGTest.ts`**这样的功能性测试助手类，也完全可以实现E2E测试。**`FSGTest.ts`** 提供的是一种封装和抽象，旨在简化和组织测试代码，使得测试脚本更加易于编写、阅读和维护。但这并非进行E2E测试的必需条件。E2E测试的核心是模拟用户对应用的实际操作，验证整个应用或系统在各种用户场景下的行为和性能。

如果没有像 **`FSGTest.ts`** 这样的测试助手类，你仍然可以直接使用测试框架（如Cypress、Selenium、Playwright等）提供的API来编写测试脚本。例如，直接在测试脚本中调用框架的方法来访问页面、查找元素、执行点击、输入数据、等待页面加载、验证页面状态等操作。这种方式可能会使得代码重复度更高，组织结构可能不如使用助手类那样清晰，但它完全能够实现E2E测试的目标。

使用助手类的好处包括：

- **代码复用**：通过抽象和封装常用操作，减少重复代码，提高测试开发效率。
- **可维护性**：将复杂的操作封装在助手类中，测试脚本更加简洁，易于理解和维护。
- **扩展性**：在助手类中添加新的方法或修改现有方法，可以轻松扩展测试功能，而不需要对每个测试用例进行大量修改。

总之，**`FSGTest.ts`**这样的测试助手类是一种优化和提高测试开发效率的工具，但并非实现E2E测试的必要条件。直接使用测试框架的API也可以编写有效的E2E测试脚本。
